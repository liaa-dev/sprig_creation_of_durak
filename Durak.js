/*
First time? Check out the tutorial game:
https://sprig.hackclub.com/gallery/getting_started

@title: 
@author: 
@tags: []
@addedOn: 2024-00-00
*/
let current_card_stack = []; // max 0-35
let bot_cards = []; // max 0-11
let player_cards = []; // max 0-11
let is_player_turn = true;

// define the sprites in our game
const clubs_6 = "a";
const clubs_7 = "b";
const clubs_8 = "c";
const clubs_9 = "d";
const clubs_10 = "e";
const clubs_j = "f";
const clubs_q = "g";
const clubs_k = "h";
const clubs_a = "i";

const spades_6 = "j";
const spades_7 = "k";
const spades_8 = "l";
const spades_9 = "m";
const spades_10 = "n";
const spades_j = "o";
const spades_q = "p";
const spades_k = "q";
const spades_a = "r";

const hearts_6 = "s";
const hearts_7 = "t";
const hearts_8 = "u";
const hearts_9 = "v";
const hearts_10 = "w";
const hearts_j = "x";
const hearts_q = "y";
const hearts_k = "z";
const hearts_a = "A";

const diamonds_6 = "B";
const diamonds_7 = "C";
const diamonds_8 = "D";
const diamonds_9 = "E";
const diamonds_10 = "F";
const diamonds_j = "G";
const diamonds_q = "H";
const diamonds_k = "I";
const diamonds_a = "J";

const card_stack = "K";
const hidden_card = "L"

const inv_plus_1 = "M";
const inv_plus_2 = "N";
const inv_plus_3 = "O";
const inv_plus_4 = "P";
const inv_plus_5 = "Q";
const inv_plus_6 = "R";
const inv_plus_7 = "S";
const arrow_upndown = "T";

const title_text_du = "U";
const title_text_rak = "V";
const play_text_pl = "W";
const play_text_ay = "X";

const player = "Y";

setLegend(
  [ clubs_6, bitmap`
...0000000000...
..022222222220..
..022000222220..
..020222222220..
..020002222220..
..020220222220..
..020220222220..
..022002022220..
..022220002220..
..022202020220..
..022000000020..
..022202020220..
..022222022220..
..022220002220..
..022222222220..
...0000000000...` ],
  [ clubs_7, bitmap`
...0000000000...
..022222222220..
..020002222220..
..022202222220..
..022202222220..
..022202222220..
..022202222220..
..022222022220..
..022220002220..
..022202020220..
..022000000020..
..022202020220..
..022222022220..
..022220002220..
..022222222220..
...0000000000...` ],
  [ clubs_8, bitmap`
...0000000000...
..022222222220..
..022002222220..
..020220222220..
..022002222220..
..020220222220..
..020220222220..
..022002022220..
..022220002220..
..022202020220..
..022000000020..
..022202020220..
..022222022220..
..022220002220..
..022222222220..
...0000000000...` ],
  [ clubs_9, bitmap`
...0000000000...
..022222222220..
..020002222220..
..020202222220..
..020002222220..
..022202222220..
..022202222220..
..022222022220..
..022220002220..
..022202020220..
..022000000020..
..022202020220..
..022222022220..
..022220002220..
..022222222220..
...0000000000...` ],
  [ clubs_10, bitmap`
...0000000000...
..022222222220..
..020220222220..
..000202022220..
..020202022220..
..020202022220..
..020220222220..
..022222022220..
..022220002220..
..022202020220..
..022000000020..
..022202020220..
..022222022220..
..022220002220..
..022222222220..
...0000000000...` ],
  [ clubs_j, bitmap`
...0000000000...
..022222222220..
..022220222220..
..022220222220..
..022220222220..
..020220222220..
..022002222220..
..022222022220..
..022220002220..
..022202020220..
..022000000020..
..022202020220..
..022222022220..
..022220002220..
..022222222220..
...0000000000...` ],
  [ clubs_q, bitmap`
...0000000000...
..022222222220..
..022002222220..
..020220222220..
..020220222220..
..020202222220..
..022020222220..
..022222022220..
..022220002220..
..022202020220..
..022000000020..
..022202020220..
..022222022220..
..022220002220..
..022222222220..
...0000000000...` ],
  [ clubs_k, bitmap`
...0000000000...
..022222222220..
..020220222220..
..020202222220..
..020022222220..
..020202222220..
..020220222220..
..022222022220..
..022220002220..
..022202020220..
..022000000020..
..022202020220..
..022222022220..
..022220002220..
..022222222220..
...0000000000...` ],
  [ clubs_a, bitmap`
...0000000000...
..022222222220..
..022002222220..
..020220222220..
..020000222220..
..020220222220..
..020220222220..
..022222022220..
..022220002220..
..022202020220..
..022000000020..
..022202020220..
..022222022220..
..022220002220..
..022222222220..
...0000000000...` ],

  [ spades_6, bitmap`
...0000000000...
..022222222220..
..022000222220..
..020222222220..
..020002222220..
..020220222220..
..020220222220..
..022002222220..
..022222022220..
..022220002220..
..022200000220..
..022200000220..
..022222022220..
..022220002220..
..022222222220..
...0000000000...` ],
  [ spades_7, bitmap`
...0000000000...
..022222222220..
..020002222220..
..022202222220..
..022202222220..
..022202222220..
..022202222220..
..022222222220..
..022222022220..
..022220002220..
..022200000220..
..022200000220..
..022222022220..
..022220002220..
..022222222220..
...0000000000...` ],
  [ spades_8, bitmap`
...0000000000...
..022222222220..
..022002222220..
..020220222220..
..022002222220..
..020220222220..
..020220222220..
..022002222220..
..022222022220..
..022220002220..
..022200000220..
..022200000220..
..022222022220..
..022220002220..
..022222222220..
...0000000000...` ],
  [ spades_9, bitmap`
...0000000000...
..022222222220..
..020002222220..
..020202222220..
..020002222220..
..022202222220..
..022202222220..
..022222222220..
..022222022220..
..022220002220..
..022200000220..
..022200000220..
..022222022220..
..022220002220..
..022222222220..
...0000000000...` ],
  [ spades_10, bitmap`
...0000000000...
..022222222220..
..020220222220..
..000202022220..
..020202022220..
..020202022220..
..020220222220..
..022222222220..
..022222022220..
..022220002220..
..022200000220..
..022200000220..
..022222022220..
..022220002220..
..022222222220..
...0000000000...` ],
  [ spades_j, bitmap`
...0000000000...
..022222222220..
..022220222220..
..022220222220..
..022220222220..
..020220222220..
..022002222220..
..022222222220..
..022222022220..
..022220002220..
..022200000220..
..022200000220..
..022222022220..
..022220002220..
..022222222220..
...0000000000...` ],
  [ spades_q, bitmap`
...0000000000...
..022222222220..
..022002222220..
..020220222220..
..020220222220..
..020202222220..
..022020222220..
..022222222220..
..022222022220..
..022220002220..
..022200000220..
..022200000220..
..022222022220..
..022220002220..
..022222222220..
...0000000000...` ],
  [ spades_k, bitmap`
...0000000000...
..022222222220..
..020220222220..
..020202222220..
..020022222220..
..020202222220..
..020220222220..
..022222222220..
..022222022220..
..022220002220..
..022200000220..
..022200000220..
..022222022220..
..022220002220..
..022222222220..
...0000000000...` ],
  [ spades_a, bitmap`
...0000000000...
..022222222220..
..022002222220..
..020220222220..
..020000222220..
..020220222220..
..020220222220..
..022222222220..
..022222022220..
..022220002220..
..022200000220..
..022200000220..
..022222022220..
..022220002220..
..022222222220..
...0000000000...` ],

  [ hearts_6, bitmap`
...0000000000...
..022222222220..
..022000222220..
..020222222220..
..020002222220..
..020220222220..
..020220222220..
..022002222220..
..022222222220..
..022223232220..
..022233333220..
..022233333220..
..022223332220..
..022222322220..
..022222222220..
...0000000000...` ],
  [ hearts_7, bitmap`
...0000000000...
..022222222220..
..020002222220..
..022202222220..
..022202222220..
..022202222220..
..022202222220..
..022222222220..
..022222222220..
..022223232220..
..022233333220..
..022233333220..
..022223332220..
..022222322220..
..022222222220..
...0000000000...` ],
  [ hearts_8, bitmap`
...0000000000...
..022222222220..
..022002222220..
..020220222220..
..022002222220..
..020220222220..
..020220222220..
..022002222220..
..022222222220..
..022223232220..
..022233333220..
..022233333220..
..022223332220..
..022222322220..
..022222222220..
...0000000000...` ],
  [ hearts_9, bitmap`
...0000000000...
..022222222220..
..020002222220..
..020202222220..
..020002222220..
..022202222220..
..022202222220..
..022222222220..
..022222222220..
..022223232220..
..022233333220..
..022233333220..
..022223332220..
..022222322220..
..022222222220..
...0000000000...` ],
  [ hearts_10, bitmap`
...0000000000...
..022222222220..
..020220222220..
..000202022220..
..020202022220..
..020202022220..
..020220222220..
..022222222220..
..022222222220..
..022223232220..
..022233333220..
..022233333220..
..022223332220..
..022222322220..
..022222222220..
...0000000000...` ],
  [ hearts_j, bitmap`
...0000000000...
..022222222220..
..022220222220..
..022220222220..
..022220222220..
..020220222220..
..022002222220..
..022222222220..
..022222222220..
..022223232220..
..022233333220..
..022233333220..
..022223332220..
..022222322220..
..022222222220..
...0000000000...` ],
  [ hearts_q, bitmap`
...0000000000...
..022222222220..
..022002222220..
..020220222220..
..020220222220..
..020202222220..
..022020222220..
..022222222220..
..022222222220..
..022223232220..
..022233333220..
..022233333220..
..022223332220..
..022222322220..
..022222222220..
...0000000000...` ],
  [ hearts_k, bitmap`
...0000000000...
..022222222220..
..020220222220..
..020202222220..
..020022222220..
..020202222220..
..020220222220..
..022222222220..
..022222222220..
..022223232220..
..022233333220..
..022233333220..
..022223332220..
..022222322220..
..022222222220..
...0000000000...` ],
  [ hearts_a, bitmap`
...0000000000...
..022222222220..
..022002222220..
..020220222220..
..020000222220..
..020220222220..
..020220222220..
..022222222220..
..022222222220..
..022223232220..
..022233333220..
..022233333220..
..022223332220..
..022222322220..
..022222222220..
...0000000000...` ],

  [ diamonds_6, bitmap`
...0000000000...
..022222222220..
..020002222220..
..022202222220..
..022202222220..
..022202222220..
..022202222220..
..022222222220..
..022222222220..
..022222322220..
..022223332220..
..022233333220..
..022223332220..
..022222322220..
..022222222220..
...0000000000...` ],
  [ diamonds_7, bitmap`
...0000000000...
..022222222220..
..020002222220..
..022202222220..
..022202222220..
..022202222220..
..022202222220..
..022222222220..
..022222222220..
..022222322220..
..022223332220..
..022233333220..
..022223332220..
..022222322220..
..022222222220..
...0000000000...` ],
  [ diamonds_8, bitmap`
...0000000000...
..022222222220..
..022002222220..
..020220222220..
..022002222220..
..020220222220..
..020220222220..
..022002222220..
..022222222220..
..022222322220..
..022223332220..
..022233333220..
..022223332220..
..022222322220..
..022222222220..
...0000000000...` ],
  [ diamonds_9, bitmap`
...0000000000...
..022222222220..
..020002222220..
..020202222220..
..020002222220..
..022202222220..
..022202222220..
..022222222220..
..022222222220..
..022222322220..
..022223332220..
..022233333220..
..022223332220..
..022222322220..
..022222222220..
...0000000000...` ],
  [ diamonds_10, bitmap`
...0000000000...
..022222222220..
..020220222220..
..000202022220..
..020202022220..
..020202022220..
..020220222220..
..022222222220..
..022222222220..
..022222322220..
..022223332220..
..022233333220..
..022223332220..
..022222322220..
..022222222220..
...0000000000...` ],
  [ diamonds_j, bitmap`
...0000000000...
..022222222220..
..022220222220..
..022220222220..
..022220222220..
..020220222220..
..022002222220..
..022222222220..
..022222222220..
..022222322220..
..022223332220..
..022233333220..
..022223332220..
..022222322220..
..022222222220..
...0000000000...` ],
  [ diamonds_q, bitmap`
...0000000000...
..022222222220..
..022002222220..
..020220222220..
..020220222220..
..020202222220..
..022020222220..
..022222222220..
..022222222220..
..022222322220..
..022223332220..
..022233333220..
..022223332220..
..022222322220..
..022222222220..
...0000000000...` ],
  [ diamonds_k, bitmap`
...0000000000...
..022222222220..
..020220222220..
..020202222220..
..020022222220..
..020202222220..
..020220222220..
..022222222220..
..022222222220..
..022222322220..
..022223332220..
..022233333220..
..022223332220..
..022222322220..
..022222222220..
...0000000000...` ],
  [ diamonds_a, bitmap`
...0000000000...
..022222222220..
..022002222220..
..020220222220..
..020000222220..
..020220222220..
..020220222220..
..022222222220..
..022222222220..
..022222322220..
..022223332220..
..022233333220..
..022223332220..
..022222322220..
..022222222220..
...0000000000...` ],

  [ card_stack, bitmap`
..0000000000....
.0222222222200..
.02233333322020.
.02323232332020.
.02332323232020.
.02323232332020.
.02332323232020.
.02323232332020.
.02332323232020.
.02323232332020.
.02332323232020.
.02323232332020.
.02332323232020.
.02233333322020.
.02222222222020.
..000000000000..` ],
  [ hidden_card, bitmap`
...0000000000...
..022222222220..
..022333333220..
..023232323320..
..023323232320..
..023232323320..
..023323232320..
..023232323320..
..023323232320..
..023232323320..
..023323232320..
..023232323320..
..023323232320..
..022333333220..
..022222222220..
...0000000000...` ],

  [ inv_plus_1, bitmap`
................
................
................
................
...........4....
.....4....44....
.....4.....4....
...44444...4....
.....4.....4....
.....4....444...
................
................
................
................
................
................` ],
  [ inv_plus_2, bitmap`
................
................
................
................
...........44...
.....4....4..4..
.....4......4...
...44444...4....
.....4....4.....
.....4....4444..
................
................
................
................
................
................` ],
  [ inv_plus_3, bitmap`
................
................
................
................
.........666....
.....6......6...
.....6....66....
...66666....6...
.....6......6...
.....6...666....
................
................
................
................
................
................` ],
  [ inv_plus_4, bitmap`
................
................
................
................
.........6..6...
.....6...6..6...
.....6...6..6...
...66666.6666...
.....6......6...
.....6......6...
................
................
................
................
................
................` ],
  [ inv_plus_5, bitmap`
................
................
................
................
.........6666...
.....6...6......
.....6...666....
...66666....6...
.....6......6...
.....6...666....
................
................
................
................
................
................` ],
  [ inv_plus_6, bitmap`
................
................
................
................
..........333...
.....3...3......
.....3...333....
...33333.3..3...
.....3...3..3...
.....3....33....
................
................
................
................
................
................` ],
  [ inv_plus_7, bitmap`
................
................
................
................
.........3333...
.....3......3...
.....3......3...
...33333....3...
.....3......3...
.....3......3...
................
................
................
................
................
................` ],
  [ arrow_upndown, bitmap `
................
................
.......01.......
......0001......
.....000001.....
....00000001....
...0000000001...
................
................
...0000000001...
....00000001....
.....000001.....
......0001......
.......01.......
................
................`],
  
  [ title_text_du, bitmap`
................
................
................
................
................
....0000..0...0.
....0...0.0...0.
....0...0.0...0.
....0...0.0...0.
....0...0.0...0.
....0000...000..
................
................
................
................
................` ],
  [ title_text_rak, bitmap`
................
................
................
................
................
0000...000..0..0
0...0.0...0.0.0.
0000..00000.00..
0...0.0...0.0.0.
0...0.0...0.0..0
0...0.0...0.0..0
................
................
................
................
................` ],
  [ play_text_pl, bitmap`
................
................
................
................
................
......4444..4...
......4...4.4...
......4444..4...
......4.....4...
......4.....4...
......4.....4444
................
................
................
................
................` ],
  [ play_text_ay, bitmap`
................
................
................
................
................
..444..4...4....
.4...4.4...4....
.44444..4.4.....
.4...4...4......
.4...4...4......
.4...4...4......
................
................
................
................
................` ],

  [ player, bitmap`
................
................
.......000......
.......000......
.......000......
.......000......
......00000.....
...00000000000..
....000000000...
.....0000000....
......00000.....
.......000......
........0.......
................
................
................`],
);

let level = 0; // this tracks the level we are on
const levels = [
  map`
..UV..
......
..WX..
......`,
  map`
.......ST
.........
.......IK
..Y......
.......MT`,
];
setMap(levels[level]);

onInput("w", () => {
  const current_level = levels[1];

  if (current_level !== undefined || level != current_level) {
    clearText("");
    setMap(current_level);
    level = current_level;
    startGame();
  }
});

onInput("j", () => {
  if(isPlayerTurn()) {
    if(getPlayerSelectedCard() != null) {
        const card = getPlayerSelectedCard();
        putCardForAttack(card, player_cards);
        putCardForDefence(getNextHighestCardFromCards(card, bot_cards, 0), bot_cards);
    }else {
        addText("NULL");
    }
  }else { // bot needs brain
    //putCardForAttack(getRandomCardFromCards());
  }
});

onInput("a", () => {
  getFirst(player).x -= 1;
});

onInput("d", () => {
  if(getFirst(player).x == 5) return;
  getFirst(player).x += 1;
});

afterInput(() => {
  
});

function startGame() {
  const bot_cards_row = 0;
  const player_cards_row = 4;

  for(let i = 0; i < 35; i++) {
    current_card_stack.push(getRandomCard());
    addText(current_card_stack.length.toString());
  }

  for(let i = 0; i < 6; i++) {
    bot_cards.push(current_card_stack[i]);
    addSprite(i, bot_cards_row, current_card_stack[i]);
    current_card_stack.splice(i, 1);
  }
  
  for(let i = 0; i < 6; i++) {
    player_cards.push(current_card_stack[i]);
    addSprite(i, player_cards_row, current_card_stack[i]);
    current_card_stack.splice(i, 1);
  }

  players_turn = true;
}

function getRandomCard() {
  const cards = 'ABCDEFGHIJabcdefghijklmnopqrstuvwxyz';
  const randomIndex = Math.floor(Math.random() * cards.length);

  // Return the randomly selected card sprite
  return cards[randomIndex];
}

function getRandomCardFromCards(cards, card_row) {
  const randomIndex = Math.floor(Math.random() * cards.length);
  return getTile(cards[randomIndex], card_row)[0];
}

function putCardForAttack(card, cards) {
  for(let i = 0; i < 5; i+= 2) {
    if(!isCardOnTile(i, 2)) {
      card.x = i;
      card.y = 2;
      cards.splice(i, 1);
      break;
    }
  }
}

function putCardForDefence(card, cards) {
  for(let i = 1; i < 6; i+= 2) {
    if(!isCardOnTile(i, 2)) {
      card.x = i;
      card.y = 2;
      cards.splice(i, 1);
      break;
    }
  }
}

function getNextHighestCardFromCards(card, cards, card_row) {
  for(let i = 0; i < cards.length; i++) {
        if (cards[i] > card.type) {
          addText("yay");
          return getTile(i, card_row)[0];
          break;
        }
        if(i == cards.length) { // Couldn't find next highest card
          addText("nooo!");
          return getRandomCardFromCards(cards, card_row);
          break;
        }
    }
}

function getPlayerSelectedCard() {
  const player_position = getFirst(player);

  const selectedCards = getTile(player_position.x, player_position.y+1);
  
  return selectedCards.find(sprite => sprite !== null);
}

function isPlayerTurn() {
  return is_player_turn;
}

function isCardOnTile(x, y) {
  const spritesOnTile = getTile(x, y);
  
  if(spritesOnTile.length > 0) {
    if(spritesOnTile.find(sprite => sprite.type === card_stack)) {
      spritesOnTile.find(sprite => sprite.type === card_stack).remove();
      addText("removed!");
      return false;
    }
    addText("yes card!");
    return true;
  }
  else return false;
}